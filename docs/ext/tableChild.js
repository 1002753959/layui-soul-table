layui.define(["table","element","form"],function(exports){var $=layui.jquery,table=layui.table,tableChildren={},ELEM_HOVER="soul-table-hover",mod={render:function(b){var t,f=this,i=$(b.elem),e=i.next().children(".layui-table-box"),y=b.id,p=e.children(".layui-table-header").children("table"),v=e.children(".layui-table-fixed").children(".layui-table-body").children("table"),x=e.children(".layui-table-body").children("table"),C=$.merge(e.children(".layui-table-body").children("table"),v),l=f.getCompleteCols(b.cols),a=[],n=void 0===b.soulSort||b.soulSort;for(f.fixHoverStyle(b),t=0;t<l.length;t++)l[t].children&&0<l[t].children.length&&a.push(t);if(void 0===i.attr("lay-filter")&&i.attr("lay-filter",y),tableChildren[y]||("function"==typeof b.rowEvent&&table.on("row("+i.attr("lay-filter")+")",function(e){var t=$(this).data("index");e.tr=C.children("tbody").children('tr[data-index="'+t+'"]'),b.rowEvent(e)}),"function"==typeof b.rowDoubleEvent&&table.on("rowDouble("+i.attr("lay-filter")+")",function(e){var t=$(this).data("index");e.tr=C.children("tbody").children('tr[data-index="'+t+'"]'),b.rowDoubleEvent(e)})),0<a.length)for(t=0;t<a.length;t++)!function(){var c=l[a[t]],e=a[t],u=c.icon||["layui-icon layui-icon-right","layui-icon layui-icon-down"];!n||b.url&&b.page||table.on("sort("+i.attr("lay-filter")+")",function(){f.render(b)}),c.isChild&&"function"==typeof c.isChild?C.find("tr").find('td[data-key$="'+c.key+'"]>div').each(function(e){c.isChild(layui.table.cache[y][e])&&(c.field?$(this).prepend('<i style="cursor: pointer" class="childTable '+u[0]+'"></i>'):$(this).html('<i style="cursor: pointer" class="childTable '+u[0]+'"></i>'))}):c.field?C.find("tr").find('td[data-key$="'+c.key+'"]>div').prepend('<i style="cursor: pointer" class="childTable '+u[0]+'"></i>'):C.find("tr").find('td[data-key$="'+c.key+'"]>div').html('<i style="cursor: pointer" class="childTable '+u[0]+'"></i>'),C.children("tbody").children("tr").each(function(){$(this).children("td:eq("+e+")").find(".childTable").on("click",function(){var e=$(this).parents("tr:eq(0)").data("index"),t=$(this).parents("td:eq(0)").data("key"),i=x.children("tbody").children("tr[data-index="+e+"]").children('td[data-key="'+t+'"]').find(".childTable:eq(0)"),l=v.find("tr[data-index="+e+"]").children('td[data-key="'+t+'"]').find(".childTable:eq(0)"),a=table.cache[b.id][e],n=c.children;if("function"==typeof c.children&&(n=c.children(a)),2===c.show)layer.open({type:1,title:"子表",maxmin:!0,content:f.getTables(this,a,c,b,n),area:"1000px",offset:"100px"}),f.renderTable(this,a,c,y,n);else{!i.hasClass(u[1])&&c.collapse&&(C.children("tbody").children("tr").children("td").find(".childTable").each(function(){$(this).hasClass(u[1])&&($(this).removeClass(u[1]).addClass(u[0]),f.destroyChildren($(this),y))}),l.children("tbody").children("tr").children("td").find(".childTable").each(function(){$(this).hasClass(u[1])&&($(this).removeClass(u[1]).addClass(u[0]),f.destroyChildren($(this),y))})),i.hasClass(u[1])||(i.parents("tr:eq(0)").children("td").find(".childTable").each(function(){$(this).hasClass(u[1])&&($(this).removeClass(u[1]).addClass(u[0]),f.destroyChildren($(this),y))}),l.parents("tr:eq(0)").children("td").find(".childTable").each(function(){$(this).hasClass(u[1])&&($(this).removeClass(u[1]).addClass(u[0]),f.destroyChildren($(this),y))})),i.hasClass(u[1])?(i.removeClass(u[1]).addClass(u[0]),l.removeClass(u[1]).addClass(u[0])):(i.removeClass(u[0]).addClass(u[1]),l.removeClass(u[0]).addClass(u[1]));var r=i.parents("td:eq(0)").attr("rowspan");if(i.hasClass(u[1])){var d=[];if(d.push('<tr class="noHover childTr"><td colspan="'+p.find("th:visible").length+'"  style="cursor: inherit; padding: 0; width: '+i.parents("tr:eq(0)").width()+'px">'),d.push(f.getTables(this,a,c,b,n)),d.push("</td></tr>"),r){var o=parseInt(i.parents("tr:eq(0)").data("index"))+parseInt(r)-1;i.parents("table:eq(0)").children().children("[data-index='"+o+"']").after(d.join(""))}else i.parents("tr:eq(0)").after(d.join(""));if(f.renderTable(this,a,c,y,n),0<v.length){var h=i.parents("tr:eq(0)").next(),s='<div class="soul-table-child-patch" style="height: '+h.children("td").height()+'px"></div>';h.children("td").children(".layui-tab-card").css({position:"absolute",top:0,background:"white","z-index":200}),h.children("td").append(s),v.find('tr[data-index="'+e+'"]').each(function(){$(this).after('<tr><td style="padding: 0;" colspan="'+$(this).children("[data-key]").length+'">'+s+"</td></tr>")}),table.resize(y)}i.parents("tr:eq(0)").next().children("td").children(".layui-tab").children(".layui-tab-content").on("click",function(e){e.stopPropagation()}).off("dblclick").on("dblclick",function(e){e.stopPropagation()})}else f.destroyChildren(i,y),v.find('tr[data-index="'+e+'"]').each(function(){$(this).next().remove()}),table.resize(y)}})}),c.spread&&2!==c.show&&C.children("tbody").children("tr").children("td").find(".childTable").trigger("click")}()},getTables:function(e,t,i,l,a){var n,r=[],d=$(l.elem),o=l.id+$(e).parents("tr:eq(0)").data("index"),h=d.next().children(".layui-table-box").children(".layui-table-body"),s=h.children("table"),c=0;if(r.push('<div class="layui-tab layui-tab-card" lay-filter="table-child-'+o+'" style="margin: 0;border: 0;'),2===i.show?r.push("max-width: "+(s.width()-2)+'px">'):(h.prop("scrollHeight")+(0<a.length?a[0].height:0)>h.height()&&(c=this.getScrollWidth()),r.push("max-width: "+(h.width()-1-c)+'px">')),void 0===i.childTitle||i.childTitle){for(r.push('<ul class="layui-tab-title">'),n=0;n<a.length;n++)r.push('<li class="'+(0===n?"layui-this":"")+'">'+("function"==typeof a[n].title?a[n].title(t):a[n].title)+"</li>");r.push("</ul>")}for(r.push('<div class="layui-tab-content" style="padding: 0 10px">'),n=0;n<a.length;n++){var u=o+n;r.push('<div class="layui-tab-item layui-show"><form action="" class="layui-form" ><table id="'+u+'" lay-filter="'+u+'"></table></form></div>')}return r.push("</div></div>"),r.join("")},renderTable:function(a,n,r,d,o){var e=[],h=this,s=d+$(a).parents("tr:eq(0)").data("index");if(r.lazy)e.push(u(h,a,n,r,d,0,o));else for(var c=0;c<o.length;c++)e.push(u(h,a,n,r,d,c,o));function u(e,t,i,l,a,n,r){var d,o=e.deepClone(r[n]),h=a+$(t).parents("tr:eq(0)").data("index")+n;return o.id=h,o.elem="#"+h,"function"==typeof o.where&&(o.where=o.where(i)),"function"==typeof o.data&&(o.data=o.data(i)),"function"==typeof o.url&&(o.url=o.url(i)),d=table.render(o),l.lazy||0===n||$("#"+h).parents(".layui-tab-item:eq(0)").removeClass("layui-show"),"function"==typeof o.checkboxEvent&&table.on("checkbox("+h+")",function(e){o.checkboxEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),"function"==typeof o.editEvent&&table.on("edit("+h+")",function(e){o.editEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),"function"==typeof o.toolEvent&&table.on("tool("+h+")",function(e){o.toolEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),"function"==typeof o.toolbarEvent&&table.on("toolbar("+h+")",function(e){o.toolbarEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),"function"==typeof o.rowEvent&&table.on("row("+h+")",function(e){o.rowEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),"function"==typeof o.rowDoubleEvent&&table.on("rowDouble("+h+")",function(e){o.rowDoubleEvent(e,table.cache[a][$(t).parents("tr:eq(0)").data("index")])}),d}tableChildren[s]=e,layui.element.on("tab(table-child-"+s+")",function(e){if(r.lazy){var t=!1;for(c=0;c<tableChildren[s].length;c++)if(tableChildren[s][c].config.id===s+e.index){t=!0;break}t||tableChildren[s].push(u(h,a,n,r,d,e.index,o))}var i=$(a).parents("tr:eq(0)").data("index"),l=$(e.elem).height();$(a).parents(".layui-table-box:eq(0)").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+i+"]").next().children().children(".soul-table-child-patch").css("height",l),$(a).parents(".layui-table-box:eq(0)").children(".layui-table-fixed").children(".layui-table-body").children("table").children("tbody").children("tr[data-index="+i+"]").next().children().children(".soul-table-child-patch").css("height",l),table.resize(d)})},destroyChildren:function(e,t){var i=e.parents("td:eq(0)").attr("rowspan");if(i){var l=e.parents("tr:eq(0)").index()+parseInt(i);e.parents("table:eq(0)").children().children("tr:eq("+l+")").remove()}else e.parents("tr:eq(0)").next().remove();var a=tableChildren[t+e.parents("tr:eq(0)").data("index")];layui.tableFilter&&layui.tableFilter.destroy(a),delete tableChildren[t+e.parents("tr:eq(0)").data("index")]},cloneJSON:function(obj){var JSON_SERIALIZE_FIX={PREFIX:"[[JSON_FUN_PREFIX_",SUFFIX:"_JSON_FUN_SUFFIX]]"},sobj=JSON.stringify(obj,function(e,t){return"function"==typeof t?JSON_SERIALIZE_FIX.PREFIX+t.toString()+JSON_SERIALIZE_FIX.SUFFIX:t});return JSON.parse(sobj,function(key,value){return"string"==typeof value&&0<value.indexOf(JSON_SERIALIZE_FIX.SUFFIX)&&0===value.indexOf(JSON_SERIALIZE_FIX.PREFIX)?eval("("+value.replace(JSON_SERIALIZE_FIX.PREFIX,"").replace(JSON_SERIALIZE_FIX.SUFFIX,"")+")"):value})||{}},fixHoverStyle:function(e){var t=$(e.elem),i=t.next().children(".layui-table-box").children(".layui-table-body").children("table"),l=t.next().children(".layui-table-box").children(".layui-table-fixed").children(".layui-table-body").children("table"),a=t.next().find("style")[0],n=a.sheet||a.styleSheet||{};this.addCSSRule(n,".layui-table-hover","background-color: inherit"),this.addCSSRule(n,".layui-table-hover.soul-table-hover","background-color: #F2F2F2"),$.merge(l.children("tbody").children("tr"),i.children("tbody").children("tr")).on("mouseenter",function(){var e=$(this),t=$(this).data("index");e.data("off")||(l.children("tbody").children("tr[data-index="+t+"]").addClass(ELEM_HOVER),i.children("tbody").children("tr[data-index="+t+"]").addClass(ELEM_HOVER))}).on("mouseleave",function(){var e=$(this),t=$(this).data("index");e.data("off")||(l.children("tbody").children("tr[data-index="+t+"]").removeClass(ELEM_HOVER),i.children("tbody").children("tr[data-index="+t+"]").removeClass(ELEM_HOVER))})},addCSSRule:function(e,t,i,l){"inserRule"in e?e.insertRule(t+"{"+i+"}",l):"addRule"in e&&e.addRule(t,i,l)},deepClone:function(e){var t=Array.isArray(e)?[]:{};if(e&&"object"==typeof e)for(var i in e)e.hasOwnProperty(i)&&(t[i]=e&&"object"==typeof e[i]?this.deepClone(e[i]):e[i]);return t},getCompleteCols:function(e){var t,i,l,a,n=this.deepClone(e);for(t=0;t<n.length;t++)for(i=0;i<n[t].length;i++)if(!n[t][i].exportHandled){if(1<n[t][i].rowspan)for((a=this.deepClone(n[t][i])).exportHandled=!0,l=t+1;l<n.length;)n[l].splice(i,0,a),l++;if(1<n[t][i].colspan){for((a=this.deepClone(n[t][i])).exportHandled=!0,l=1;l<n[t][i].colspan;l++)n[t].splice(i,0,a);i=i+n[t][i].colspan-1}}return n[n.length-1]},getScrollWidth:function(e){var t=0;return e?t=e.offsetWidth-e.clientWidth:((e=document.createElement("div")).style.width="100px",e.style.height="100px",e.style.overflowY="scroll",document.body.appendChild(e),t=e.offsetWidth-e.clientWidth,document.body.removeChild(e)),t}};exports("tableChild",mod)});